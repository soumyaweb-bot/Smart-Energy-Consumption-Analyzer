<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Energy Consumption Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        h1, h2, h3 { color: #333; }
        pre { background: #f4f4f4; padding: 15px; border-radius: 5px; white-space: pre-wrap; }
        canvas { margin-top: 30px; }
        button {
            background-color: #4CAF50; color: white; padding: 12px 20px;
            border: none; border-radius: 4px; cursor: pointer; font-size: 16px;
        }
        button:hover { background-color: #45a049; }
        .info-box {
            background-color: #f9f9f9; padding: 15px; border-left: 5px solid #4CAF50;
            margin-bottom: 20px; border-radius: 4px;
        }
        form { margin-bottom: 20px; }
        label { margin-right: 10px; }
    </style>
</head>
<body>

<h1>Smart Energy Consumption Analyzer</h1>

<!-- New: Date Range Filter Form -->
<form method="POST" action="/filter">
  <label for="start_date">Start Month:</label>
  <input type="month" id="start_date" name="start_date" required>
  <label for="end_date">End Month:</label>
  <input type="month" id="end_date" name="end_date" required>
  <button type="submit">Filter by Date Range</button>
</form>

<!-- Existing: Generate Report Button -->
<form action="/analyze" method="post">
    <button type="submit">Generate Energy Optimization Report</button>
</form>

{% if report %}
    <h2>Generated Energy Optimization Report</h2>
    <pre>{{ report }}</pre>
{% endif %}

<div class="info-box">
    <h3>Next Month's Prediction</h3>
    <p><strong>Predicted Consumption:</strong> {{ prediction.predicted_next_month }} kWh</p>
    <p><strong>Average Monthly Consumption:</strong> {{ prediction.average_consumption }} kWh</p>
    <p><strong>Last Month Consumption:</strong> {{ prediction.last_month_consumption }} kWh</p>
    <p><strong>Trend (last two months):</strong> {{ prediction.trend }} kWh</p>
</div>

<div class="info-box">
    <h3>Month with Highest Energy Consumption</h3>
    <p><strong>{{ highest_month.month }}</strong> consumed <strong>{{ highest_month.consumption_kwh }} kWh</strong></p>
    <p><strong>Top Appliances:</strong></p>
    <ul>
        {% for appliance, consumption in highest_month.appliances.items() %}
            <li>{{ appliance }}: {{ consumption }} kWh</li>
        {% endfor %}
    </ul>
</div>

<!-- Line chart for total monthly consumption -->
<h3>Total Monthly Energy Consumption</h3>
<div style="position: relative; width: 100%; max-width: 800px; margin: auto;">
    <canvas id="totalConsumptionChart" style="width: 100%; height: 400px;"></canvas>
    </div>
     

<!-- Pie chart for annual appliance consumption -->
<h3>Annual Appliance Consumption Distribution</h3>
<div style="position: relative; width: 100%; max-width: 500px; margin: auto;">
    <canvas id="appliancePieChart" style="width: 100%; height: 50px;"></canvas>
    </div>

<script type="text/javascript">
    const rawData = JSON.parse(`{{ consumption_data | tojson | safe }}`);
    const months = rawData.monthly_consumption_kwh.map(item => item.month);
    const totalConsumption = rawData.monthly_consumption_kwh.map(item => item.total_consumption_kwh);

    const applianceSummary = JSON.parse('{{ annual_appliance_consumption | tojson | safe }}');
    const applianceLabels = Object.keys(applianceSummary);
    const applianceValues = Object.values(applianceSummary);

    // Line Chart: Total Consumption
    new Chart(document.getElementById('totalConsumptionChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Total Energy Consumption (kWh)',
                data: totalConsumption,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Total Energy Consumption Per Month'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Pie Chart: Annual Appliance Consumption
    new Chart(document.getElementById('appliancePieChart').getContext('2d'), {
        type: 'pie',
        data: {
            labels: applianceLabels,
            datasets: [{
                data: applianceValues,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.5)',
                    'rgba(54, 162, 235, 0.5)',
                    'rgba(255, 206, 86, 0.5)',
                    'rgba(75, 192, 192, 0.5)',
                    'rgba(153, 102, 255, 0.5)'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Annual Appliance Consumption Distribution'
                }
            }
        }
    });
</script>

</body>
</html>
